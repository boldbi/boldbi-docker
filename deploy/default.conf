upstream idweb {
	server id_web_container:80;
}

upstream idapi {
	server id_api_container:80;
}

upstream idums {
	server id_ums_container:80;
}

upstream biweb {
	server bi_web_container:80;
}

upstream biapi {
	server bi_api_container:80;
}

upstream bijobs {
	server bi_jobs_container:80;
}

upstream bidataservice {
	server bi_dataservice_container:80;
}

server {
	listen        80;
	
	#listen 443 ssl;
	#ssl on;
	#ssl_certificate /path/to/certificate/file/domain.crt;
	#ssl_certificate_key /path/to/key/file/domain.key;
	
	proxy_read_timeout 300;
	proxy_connect_timeout 300;
	proxy_send_timeout 300;
	send_timeout 300;
	client_max_body_size 100M;

	location / { 
		root               /boldbi/idp/web/wwwroot;
		proxy_pass         http://idweb/;
		proxy_http_version 1.1;
		proxy_set_header   Upgrade $http_upgrade;
		proxy_set_header   Connection keep-alive;
		proxy_set_header   Host $http_host;
		proxy_cache_bypass $http_upgrade;
		proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header   X-Forwarded-Proto $scheme;
	}
	location /api {
		proxy_pass         http://idapi/api;
		proxy_http_version 1.1;
		proxy_set_header   Upgrade $http_upgrade;
		proxy_set_header   Connection keep-alive;
		proxy_set_header   Host $http_host;
		proxy_cache_bypass $http_upgrade;
		proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header   X-Forwarded-Proto $scheme;
	}
	location /ums {
		root               /boldbi/idp/ums/wwwroot;
		proxy_pass         http://idums/ums;
		proxy_http_version 1.1;
		proxy_set_header   Upgrade $http_upgrade;
		proxy_set_header   Connection keep-alive;
		proxy_set_header   Host $http_host;
		proxy_cache_bypass $http_upgrade;
		proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header   X-Forwarded-Proto $scheme;
	}
	location /ums/signalr/progresshub { 
		proxy_pass         http://idums/ums/signalr/progresshub;
		proxy_http_version 1.1;
		proxy_set_header   Upgrade $http_upgrade;
		proxy_set_header   Connection "upgrade";
		proxy_set_header   Host $http_host;
		proxy_cache_bypass $http_upgrade;
		proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header   X-Forwarded-Proto $scheme;
	}
	location /bi { 
		root               /boldbi/bi/web/wwwroot;
		proxy_pass         http://biweb/bi;
		proxy_http_version 1.1;
		proxy_set_header   Upgrade $http_upgrade;
		proxy_set_header   Connection keep-alive;
		proxy_set_header   Host $http_host;
		proxy_cache_bypass $http_upgrade;
		proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header   X-Forwarded-Proto $scheme;
		if ($request_filename ~* ^.*?/([^/]*?)$)
		{
			set $filename $1;
		}
		if ($filename ~* ^.*?\.(eot)|(ttf)|(woff)$)
		{
			add_header Access-Control-Allow-Origin *;
		}
	}
	location /bi/messageHub { 
		proxy_pass         http://biweb/bi/messageHub;
		proxy_http_version 1.1;
		proxy_set_header   Upgrade $http_upgrade;
		proxy_set_header   Connection "upgrade";
		proxy_set_header   Host $http_host;
		proxy_cache_bypass $http_upgrade;
		proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header   X-Forwarded-Proto $scheme;
	}
	location /bi/api {
		proxy_pass         http://biapi/bi/api;
		proxy_http_version 1.1;
		proxy_set_header   Upgrade $http_upgrade;
		proxy_set_header   Connection keep-alive;
		proxy_set_header   Host $http_host;
		proxy_cache_bypass $http_upgrade;
		proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header   X-Forwarded-Proto $scheme;
	}
	location /bi/jobs {
		proxy_pass         http://bijobs/bi/jobs;
		proxy_http_version 1.1;
		proxy_set_header   Upgrade $http_upgrade;
		proxy_set_header   Connection keep-alive;
		proxy_set_header   Host $http_host;
		proxy_cache_bypass $http_upgrade;
		proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header   X-Forwarded-Proto $scheme;
	}
	location /bi/designer {
		root               /boldbi/bi/designer/wwwroot;
		proxy_pass         http://bidataservice;
		proxy_http_version 1.1;
		proxy_set_header   Upgrade $http_upgrade;
		proxy_set_header   Connection keep-alive;
		proxy_set_header   Host $http_host;
		proxy_cache_bypass $http_upgrade;
		proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header   X-Forwarded-Proto $scheme;
	}
	location /bi/designer/helper {
		proxy_pass http://bidataservice/bi/designer/helper;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";
		proxy_set_header Host $http_host;
		proxy_cache_bypass $http_upgrade;
		proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header   X-Forwarded-Proto $scheme;
	}
}
